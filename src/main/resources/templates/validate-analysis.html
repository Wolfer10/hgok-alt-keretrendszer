<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Elemzés validálása</title>
    <link th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css}" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!--    <link rel="stylesheet" th:href="@{/css/default.min.css}">-->
    <!--    <link rel="stylesheet" th:href="@{/css/intellij-light.min.css}">-->
    <link rel="stylesheet" th:href="@{/css/vs.min.css}">
    <script th:src="@{/js/highlight.min.js}"></script>
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <link th:href="@{/css/validation.css}" rel="stylesheet">
    <link th:href="@{/css/global.css}" rel="stylesheet">
</head>
<body>
<div th:insert="header :: navbar"></div>

<div id="main">
    <h1>Elemzés  <span th:text="${analyis.getId()}"></span></h1>
    <div th:if="${analyis.getComparedAnalysis().getLinks().size() > 0}" >
        <div th:if="${currentLink != null}" id="content">
            <div class="grid-block" >
                <div class="column-wrapper">
                    <h2 th:text="${currentLink.getSourceRelativeFileName() + ' sor:' + currentLink.getSourceStartLine()}" ></h2>
                    <h3 th:text="${currentLink.getSourceFunctionName()}" ></h3>
                    <h4>Hívó kód</h4>
                </div>
<!--                <pre class="source" th:utext="${currentLink.getSourceSnippet()}"></pre>-->
                <pre class="source" id="s" th:utext="${currentLink.getSourceFunction()}"></pre>
                <div class="column-wrapper">
                    <h2 th:text="${currentLink.getTargetRelativeFileName() + ' sor:' + currentLink.getTargetStartLine()}" ></h2>
                    <h3 id="targetName" th:text="${currentLink.getTargetFunctionName()}" ></h3>
                    <h4>Hívott kód</h4>
                </div>
<!--                <pre class="target" th:utext="${currentLink.getTargetSnippet()}"></pre>-->
                <pre class="target" id="t" th:utext="${currentLink.getTargetFunction()}"></pre>
                <div id="aside">
                    <div id="probs">
                        <div class="tool">
                            <p class="probs-item">Az eszköz(ök) ami megtalálta:</p>
                            <ul class="tool-name" th:each="toolName : ${foundBy}">
                                <li th:text="${toolName}"></li>
                            </ul>
                        </div>
                        <p>Az eddigi elemzés alapján az él helyességének valószínűsége
                            <span> 70% </span>
                            <span class="result" th:text="${currentLink.getMatched() ? 'Helyes' : 'Helytelen'}" > </span>
                        </p>

                    </div>
                    <form id="validation-form">
                        <div class="labels">
                            <label>
                                -
                                <input type="radio" name="valid-link" value="unchecked"
                                       th:checked="${currentLink.getState() == unchecked}">
                            </label>
                            <label>
                                Helyes él
                                <input type="radio" name="valid-link" value="accepted"
                                       th:checked="${ currentLink.getState() ==  accepted}">
                            </label>
                            <label>
                                Helytelen él
                                <input type="radio" name="valid-link" value="denied"
                                       th:checked="${currentLink.getState() == denied}">
                            </label>
                        </div>
                        <hr>
                    </form>
                    <div class="stepping column-wrapper">
                        <form th:if="${linkIterator.hasNext()}"
                              th:action="@{/validate/{analysisId}/nextlink/{id}(id=${currentLink.getId()},analysisId=${analyis.getId()})}">
                            <input type="submit" value="Következő">
                        </form>
                        <form th:if="${linkIterator.hasPrevious()}"
                              th:action="@{/validate/{analysisId}/prevlink/{id}(id=${currentLink.getId()},analysisId=${analyis.getId()})}">
                            <input type="submit" value="Előző">
                        </form>
                        <form th:if="${!linkIterator.hasNext()}" th:action="@{/validate/end}" method="post">
                            <input type="submit" value="Kész">
                        </form>
                        <hr>
                    </div>
                    <div class="flex"><span th:text="${linkIterator.currentPointer + 1}"> </span> / <span th:text="${linkIterator.size}"></span> </div>
                </div>

            </div>
            <!--        <p th:text="${currentLink.getAccepted()}"></p>-->

        </div>
        <div th:unless="${currentLink != null}">
            <form th:action="@{/validate/end}" method="post">
                <input type="submit" value="Kész">
            </form>
            Valami hiba történt
        </div>

    </div>
    <div th:unless="${analyis.getComparedAnalysis().getLinks().size() > 0}">
        <form th:action="@{/validate/end}" method="post">
            <input type="submit" value="Kész">
        </form>
        Nem találtunk éleket
    </div>


    <script th:inline="javascript">
        function exucute_validation() {
            $.post(/*[[ @{/validateLink} ]]*/, {valid_link: $("input[name='valid-link']:checked").val()});
        }
        window.onload = () => {
            var form = document.getElementById("validation-form");
            form.addEventListener("submit", function (event) {
                event.preventDefault(); // prevent form submission and reloading the page.
            });
            $("input[name='valid-link']").change(exucute_validation);
            //console.log(document.querySelectorAll('pre'));
            document.querySelectorAll('pre').forEach((el) => {
                hljs.highlightElement(el);
            });
            highlight();
        };

        function highlight(){
            const regex = new RegExp(document.getElementById('targetName').innerHTML, 'gi');
            const source = document.getElementById('s');
            let text = source.innerHTML;
            text = text.replace(/(<mark class="highlight">|<\/mark>)/gim, '');
            source.innerHTML = text.replace(regex, '<mark class="highlight">$&</mark>');
        }


    </script>
</div>


</body>
</html>